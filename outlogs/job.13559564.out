--- Arguments Loaded ---
{
    "output_dir": "./results/QWEN-fewshotps",
    "agent_setup": "FewShot",
    "seed": 42,
    "batch_size": 8,
    "num_workers": 4,
    "model_id": "Qwen/Qwen2.5-VL-7B-Instruct",
    "max_new_tokens": 128,
    "data_path": "/scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/test.jsonl",
    "few_shot_data_path": "/scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/train.jsonl",
    "num_shots": 2,
    "modalities": "ps",
    "load_cxr": null,
    "load_ehr": null,
    "load_rr": null,
    "ablation": null,
    "normalizer_state": null,
    "ehr_data_dir": "/scratch/fs999/shamoutlab/data/mimic-iv-extracted",
    "cxr_data_dir": "/scratch/fs999/shamoutlab/data/physionet.org/files/mimic-cxr-jpg/2.0.0",
    "debug_samples": 2
}
--------------------------
Random seed set to: 42
Results will be saved to: ./results/QWEN-fewshotps

[Status] Initializing Data Loader from: /scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/test.jsonl

[Pre-Loading] Initializing parallel workers (4) to load data into RAM...
[Pre-Loading] Successfully loaded 4925 samples into RAM.

Starting simulation with agent setup: 'FewShot'...
Initializing Model and Processor for 'Qwen/Qwen2.5-VL-7B-Instruct'...
⚡ Applying Left-Padding fix for Qwen (Fixes 'addCriterion' bug)...
Loading Qwen/Qwen2.5-VL-7B-Instruct as Qwen2_5_VLForConditionalGeneration...
✅ Using Token IDs - Yes: 9454, No: 2753
✅ Model loaded successfully.
Loading few-shot support set from /scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/train.jsonl...

--- DEBUG SAMPLE (1/2) ---
Stay ID: 37510196
[TEXT BLOCK]: You are an expert ICU risk prediction model. Here are some examples of patient data and their outcomes.


[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 26
 - Gender: F
 - Ethnicity: WHITE

History of Present Illness:
___ is a ___ year old woman with no PMH.

Past Medical History:


Past Surgical History:
Not available

Social History:
___...
[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 63
 - Gender: M
 - Ethnicity: WHITE

History of Present Illness:
___ year old male with h/o DM and HTN who was admitted to OSH 
with pancreatitis, now being transferred to ___ with acute 
...
[TEXT BLOCK]: Now, analyze this new patient:

[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 68
 - Gender: F
 - Ethnicity: BLACK/AFRICAN AMERICAN

History of Present Illness:
___ with COPD who has been admitted 9 times since ___ for 
dyspnea, CAD, atrial fibrillation on apixaban w...
--------------------------------------------------


--- DEBUG SAMPLE (2/2) ---
Stay ID: 39880770
[TEXT BLOCK]: You are an expert ICU risk prediction model. Here are some examples of patient data and their outcomes.


[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 26
 - Gender: F
 - Ethnicity: WHITE

History of Present Illness:
___ is a ___ year old woman with no PMH.

Past Medical History:


Past Surgical History:
Not available

Social History:
___...
[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 63
 - Gender: M
 - Ethnicity: WHITE

History of Present Illness:
___ year old male with h/o DM and HTN who was admitted to OSH 
with pancreatitis, now being transferred to ___ with acute 
...
[TEXT BLOCK]: Now, analyze this new patient:

[TEXT BLOCK]: --- Patient DATA ---

Patient Summary:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 28
 - Gender: F
 - Ethnicity: WHITE

History of Present Illness:
___ s/p transferred to ___ from ___, where she was 
originally brought in by EMS due to MVC. Patient was found 
unrestraine...
--------------------------------------------------

...Simulation complete.

Evaluating predictions...
...Evaluation complete.

==================================================
      Pipeline Finished Successfully
==================================================

Agent Setup: FewShot

--- Evaluation Summary ---
{
    "in_hospital_mortality_metrics": {
        "Survived": {
            "precision": 0.93929173693086,
            "recall": 0.5143120960295475,
            "f1-score": 0.6646778042959427,
            "support": 4332.0
        },
        "Mortality": {
            "precision": 0.17587152369761067,
            "recall": 0.7571669477234402,
            "f1-score": 0.28544183089637637,
            "support": 593.0
        },
        "accuracy": 0.5435532994923857,
        "macro avg": {
            "precision": 0.5575816303142354,
            "recall": 0.6357395218764939,
            "f1-score": 0.47505981759615956,
            "support": 4925.0
        },
        "weighted avg": {
            "precision": 0.8473712929821662,
            "recall": 0.5435532994923857,
            "f1-score": 0.6190154830317918,
            "support": 4925.0
        },
        "auroc": 0.6357395218764939,
        "auprc": 0.16240268346979359
    },
    "modality_usage_analysis": {
        "total_modality_requests": 4925,
        "average_modalities_per_patient": 1.0,
        "request_counts": {
            "patient_summary": 4925,
            "ehr_timeseries": 0,
            "cxr": 0,
            "radiology_report": 0
        },
        "percentage_of_patients_requesting_modality": {
            "patient_summary": 1.0,
            "ehr_timeseries": 0.0,
            "cxr": 0.0,
            "radiology_report": 0.0
        },
        "percentage_request_when_available": {
            "cxr": 0.0,
            "radiology_report": 0.0
        }
    },
    "total_patients_evaluated": 4925
}

Detailed results saved to: ./results/QWEN-fewshotps/FewShot_detailed_results.json
Evaluation summary saved to: ./results/QWEN-fewshotps/FewShot_evaluation_summary.json
