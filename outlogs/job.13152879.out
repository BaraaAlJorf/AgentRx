--- Arguments Loaded ---
{
    "output_dir": "./results/varyingmods",
    "agent_setup": "SingleAgent",
    "seed": 42,
    "batch_size": 8,
    "num_workers": 4,
    "model_id": "HuggingFaceM4/idefics2-8b",
    "max_new_tokens": 128,
    "data_path": "/scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/val.jsonl",
    "modalities": "EHR-CXR-RR-DN",
    "load_cxr": null,
    "load_ehr": null,
    "load_rr": null,
    "ablation": null,
    "normalizer_state": null,
    "ehr_data_dir": "/scratch/fs999/shamoutlab/data/mimic-iv-extracted",
    "cxr_data_dir": "/scratch/fs999/shamoutlab/data/physionet.org/files/mimic-cxr-jpg/2.0.0",
    "debug_samples": 10
}
--------------------------
Random seed set to: 42
Results will be saved to: ./results/varyingmods
Data loaded from: /scratch/baj321/MedAgent/datasets/multimodal_dataset_splits/val.jsonl

Starting simulation with agent setup: 'SingleAgent'...
Initializing Model and Processor for 'HuggingFaceM4/idefics2-8b'...
✅ Found Canonical Yes ID: 5592, Canonical No ID: 1770
✅ Model 'HuggingFaceM4/idefics2-8b' and Processor loaded successfully.

--- DEBUG: SINGLE AGENT SAMPLE (1/10) ---
Stay ID: 38484652
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 69
 - Gender: F
 - Ethnicity: BLACK/AFRICAN AMERICAN

History of Present Illness:
___ y/o woman with history of HTN and T2 DM (non-insulin 
dependent), admitted to OSH (___), for dyspnea and single 
episode of syncope. Ms. ___ reports that she has been feeling 
increasing DOE starting 2 days PTA walking to and from her 
bathroom. She originally attributed this to accidentally taking 
twice her regular dose of HCTZ. She felt slightly better 1 day 
PTA, but on morning of admission, she was walking in her kitchen 
when she became SOB with new sensation of LH. The next thing she 
remembered was waking up on the floor. Per her grandson, she had 
lost consciousness and fallen. She denies any chest pain 
throughout these events and does not think she sustained any 
injuries to her head or elsewhere due to her syncopal fall.

Past Medical History:
HTN
T2DM (not on insulin)
HLP
Total Knee Replacement (Left) in ___
Hysterectomy in ___

Past Surgical History:
Not available

Social History:
___

Family History:


Medications on Admission:
ASA 81mg PO daily
HCTZ 25 mg PO daily
Losartan 100mg PO daily
Amlodipine 10mg PO daily
Carvedilol 3.125mg PO BID
Metformin 100mg PO BID
Pravastatin 40


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (2/10) ---
Stay ID: 34098275
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 71
 - Gender: M
 - Ethnicity: WHITE

History of Present Illness:
___ male known to our service, who was discharged from ___ 
after a stay for resecton of a R fronal brain tumor diagnosed to 
be GBM (Glioblastoma multiforme).  Today, he suffered a 
witnessed fall at Rehab. Fall was witnessed by RN at facility, 
positive LOC, question of transient CPR, then transported to 
___. Ambulance flow sheet indicates that there was no trauma 
at the time of the fall.

Past Medical History:


Past Surgical History:
Not available

Social History:
___

Family History:
non-

Medications on Admission:



--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (3/10) ---
Stay ID: 35501216
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 70
 - Gender: M
 - Ethnicity: UNKNOWN

History of Present Illness:
___ M with hx of alcohol/opioid abuse, hepatitis C, CKD, CVA, 
___ transferred from ___ after found to be in 
respiratory distress and cyanotic at homeless shelter and 
intubated on site, transferred to ___ because there is no 
current ICU bed in ___.

Past Medical History:
-uncontrolled ___ s/p amputation of toe of R foot
-hyperlipidemia
-hypertension
-CVA with residual dysarthria, mild R facial droop in ___
-opiod, tobacco, alcohol abuse
-COPD
-carotid stenosis
-OA
-CKD stage III
-bradycardia
-

Past Surgical History:
Not available

Social History:
___

Family History:
mother and father died of MI in late ___

Medications on Admission:
The Preadmission Medication list is accurate and complete.
1. ___ 30 Units Breakfast
___ 15 Units Bedtime
2. Gabapentin 300 mg PO TID 
3. Clopidogrel 75 mg PO DAILY 
4. Metoprolol Succinate XL 50 mg PO DAILY 
5. Pravastatin 40 mg PO DAILY 
6. tadalafil 0.5  oral PRN erectile dysfunction 
7. Tiotropium Bromide 1 CAP IH DAILY 
8. Amlodipine 10


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (4/10) ---
Stay ID: 33539556
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 89
 - Gender: M
 - Ethnicity: WHITE

History of Present Illness:
___ is a ___ male who presents as a transfer from OSH 
on ___ after being found down. The patient does not recall 
falling. He was taken to an OSH where a CT head showed blood in 
the third and fourth ventricle. He was subsequently transferred 
to ___ for further evaluation.

Past Medical History:
- Atrial Fibrillation on Pradaxa  
 - COPD on chronic prednisone  
 - LL lung cancer s/p lobectomy and XRT in ___  
 - CAD s/p PCI in ___ (at ___, ___ 
and ___) c/b Right femoral pseudoanyrsm requiring bypass.  
 - GERD  
 - Biliary diversion surgery  
 - colectomy with reanastamosis.  
 - "stomach surgeries"  
 - hiatal hernia surgery.

Past Surgical History:
Not available

Social History:
___

Family History:


Medications on Admission:
The Preadmission Medication list is accurate and complete.
1. Omeprazole 20 mg PO BID 
2. Tiotropium Bromide 1 CAP IH DAILY 
3. PredniSONE 5 mg PO EVERY OTHER DAY 
4. Multivitamins 1 TAB PO DAILY 
5. Aspirin 81 mg PO DAILY 
6. Sucralfate 1 gm PO BID 
7. Clopidogrel 75 mg PO DAILY 
8. Atorvastatin 80 mg PO QPM 
9. Tamsulosin 0.4 mg PO DAILY 
10. Fluocinolone Acetonide 0.025% Cream 1 Appl TP BID 
11. Meclizine 12.5


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (5/10) ---
Stay ID: 38979073
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 28
 - Gender: F
 - Ethnicity: OTHER

History of Present Illness:
___ DM1, HCV on ribavarin and pegasys x5 weeks, recently started 
on boceprevir p/w N/V since this AM. Increased nausea and poor 
PO intake since beginning boceprevir, especially as of ___ days 
PTA. Blood sugars have been in 400s over past several days. 
Denies hematemesis but reports dark brown emesis, with black 
streaks but no coffee grounds. 10 episodes vomiting since this 
AM. Has had 4 episodes of DKA in the past, 3 in the past 13 
months. No abdominal cramps, no diarrhea or constipation, last 
normal bowel movement last night. Has had some recent weight 
loss attributable to poor PO intake.  Mother and father very 
involved in management of medical problems, she admits she does 
not a good job managing them by herself.

Past Medical History:
Chronic HCV-diagnosed ___
DMI-diagnosed ___

Past Surgical History:
Not available

Social History:
___

Family History:
Non-

Medications on Admission:
Preadmission medications listed are correct and complete.  
Information was obtained from Patient.
1. Boceprevir 800 mg PO Q8H 
2. Peginterferon Alfa-2a 180 mcg SC 1X/WEEK (SA) 
3. Ribavirin 600 mg PO QAM 
4. Ribavirin 400 mg PO QPM 
5. Prochlorperazine 5 mg PO Q6H:PRN nausea 
6. Glargine 25 Units Breakfast
Glargine 25 Units Bedtime
Insulin SC Sliding Scale using HUM Insulin
7. Vitamin D ___ UNIT PO DAILY 
8. Multivitamins W/minerals 1


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (6/10) ---
Stay ID: 38021408
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 42
 - Gender: F
 - Ethnicity: WHITE

History of Present Illness:
___ with extensive hx including SLE, CKD, HTN, and h/o CVA on 
warfarin
who presented today for elective catheterization, now admitted 
for acute on chronic anemia.

Past Medical History:
Anemia
SLE 
- Since ___
- Chronic low C3 and elevanted dsDNA
- Lupus anticoagulant and anticardiolipin ab
Membranous glomerulonephritis ___ renal bx at ___ with 
macrovascular thrombosis, sp cytoxan and imuran; on Coumadin)
HTN
Osteoporosis
Fibromyalgia
Avascular necrosis
Lacunar stroke
Pyoderma ___ lacunar stroke
___ pyoderma ___

Past Surgical History:
Not available

Social History:
___

Family History:
SLE
Fibromyalgia
Discoid lupus
Hypertension
Melanoma
Father with a CABG in his ___. He is also s/p pacemaker.

Medications on Admission:
The Preadmission Medication list is accurate and complete.
1. Methylprednisolone 4 mg PO DAILY 
2. Hydroxychloroquine Sulfate 200 mg PO EVERY OTHER DAY 
3. Hydroxychloroquine Sulfate 100 mg PO EVERY OTHER DAY 
4. Zolpidem Tartrate 10 mg PO QHS insomnia 
5. Lorazepam 1 mg PO ONCE MR1 anxiety 
6. Warfarin 14 mg PO DAILY16 
7. Simvastatin 10 mg PO 2X/WEEK (MO,FR) 
8. Doxycycline Hyclate 100 mg PO TID 
9. Chlorthalidone 50


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (7/10) ---
Stay ID: 32808961
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 56
 - Gender: F
 - Ethnicity: BLACK/AFRICAN AMERICAN

History of Present Illness:
___ year old female with type 1 diabetes mellitus with multiple 
recents hospitalization and considerable complications of her 
disease, hypertension, and Graves disease with 3 days of nausea, 
vomiting (~4 times a day), diarrhea, and epigastric pain 
(___). She reports that she has been taking her Lantus, but 
had not continued with her Humalog dosing.  Most recent FSBGs 
for her were in the 300s-400s, but she did not inform any of her 
doctors about this.  She has had markedly decreased PO intake 
over the past 3 days as well.  She also acknowledges that her 
allergies have been a bit less controlled as of late.  She 
initially stated that her loose stools were bright red in color, 
but then explained that she was not sure.  When her vomitous 
started to become darker, she was finally worried enough to come 
to the hospital.  Upon transfer to ___ ED, per EMS report, 
emesis was black/brown. She was very drowsy, but responsive and 
arousable.  She was actively complaining of epigastric pain to 
palpation, without rebound or guarding.

Past Medical History:
---

Past Surgical History:
Not available

Social History:
___

Family History:
Mother died of colon cancer. There are multiple family members 
with DM.

Medications on Admission:
1. amitriptyline 50 mg qhs
2. fluticasone-salmeterol 250-50 mcg BID 
3. hyoscyamine sulfate 0.375 mg BID
4. losartan 50 mg daily
5. methimazole 10 mg TID
6. montelukast 10 mg daily
7. pantoprazole 40 mg daily
8. polyethylene glycol 3350 17 gram/dose daily  
9. simvastatin 20 mg daily
10. sulfasalazine 1000 mg BID
11. prochlorperazine maleate 10 mg BID
12. docusate sodium 100 mg BID
13. gabapentin 900 mg TID
14. metoclopramide 10 mg QIDACHS  
15. calcium carbonate 200 mg calcium (500 mg) TID
16. cholecalciferol (vitamin D3) 800 unit daily
17. ferrous sulfate 300  mg (60 mg iron) daily
18. oxycodone-acetaminophen ___ mg BID PRN pain
19. insulin glargine 18 units qAM, 24 units qPM
20. Humalog 2 - 10 Units TID per scale (up to 67 units a day, 
per sliding scale)


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (8/10) ---
Stay ID: 38898533
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 79
 - Gender: F
 - Ethnicity: WHITE

History of Present Illness:
Ms. ___ is a ___ year old woman with a past medical history of 
COPD (not on home O2), lung ca (s/p resection), ___ (LVEF 
___, CAD (s/p MI and x4 stents), HTN, HLD who presents with 
weakness, fever, poor PO intake. Over the past 2.5 days the 
patient reports decreased appetite, decreased PO intake, and 
weakness. She feels weak in her limbs and her legs "buckle" 
under her when she tries to walk without a walker. She had 
moderate lightheadedness when standing. Due to her difficulty 
getting up she has not been taking her medications as frequently 
as prescribed including inhalers and furosemide. She endorses 
moderately worse productive cough than her baseline. She 
describes "fullness" in the chest but no chest pain. She denies 
fevers, chills, shortness of breath, abdominal pain, nausea, 
vomiting, diarrhea, dysuria. She has intermittent lower back 
pain. She denies sick contacts.

Past Medical History:
COPD not on home O2
CHF EF ___ in ___

Past Surgical History:
Not available

Social History:
___

Family History:
Several siblings died suddenly in their ___ and ___.

Medications on Admission:
The Preadmission Medication list is accurate and complete.
1. Albuterol 0.083% Neb Soln 1 NEB IH Q6H:PRN SOB/wheeze 
2. Furosemide 20 mg PO DAILY 
3. Ipratropium Bromide Neb 1 NEB IH Q6H:PRN SOB/wheeze 
4. Metoprolol Succinate XL 50 mg PO DAILY 
5. Lisinopril 2.5 mg PO DAILY 
6. Acetaminophen 650 mg PO Q8H:PRN Pain - Mild 
7. Albuterol Inhaler 2 PUFF IH Q6H:PRN SOB 
8. Aspirin 81 mg PO DAILY 
9. Atorvastatin 80 mg PO QPM 
10. Citalopram 20 mg PO DAILY 
11. Clopidogrel 75 mg PO DAILY 
12. Gabapentin 600 mg PO DAILY 
13. LORazepam 1 mg PO BID 
14. Mirtazapine 45 mg PO QHS 
15. Pantoprazole 40 mg PO Q24H 
16. Spironolactone 25 mg PO DAILY 
17. TraMADol 50 mg PO Q6H:PRN Pain - Moderate 
18. Voltaren (diclofenac sodium) 1 % topical QID 
19. Lidocaine 5% Patch 1 PTCH TD DAILY 
20. Ferrous Sulfate 325 mg PO TID 
21. Ipratropium-Albuterol Inhalation Spray 2 INH IH Q6H 
22. Spiriva Respimat (tiotropium bromide) 2.5 mcg/actuation 
inhalation DAILY 
23. Nitroglycerin SL 0.4 mg SL Q5


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (9/10) ---
Stay ID: 37225870
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 52
 - Gender: M
 - Ethnicity: WHITE

History of Present Illness:
Mr. ___ is a ___ yo M with PMHx notable for new diagnosis 
of IgA MM diagnosed in the setting of compression fractures of 
T8, 11 and 12, now on bortezomib, dexamethasone and lenalidomide 
(started bortezomib/dex on ___ and lenalidomide ___ who 
is admitted to ___ in the setting of worsening back pain and 
concern for cord compression.

Past Medical History:
___:

Past Surgical History:
Not available

Social History:
___

Family History:
Uncle and cousin with leukemia. No other family history of 
malignancy. Parents alive in ___, father with CVA several years 
ago.

Medications on Admission:
The Preadmission Medication list is accurate and complete.
1. Acetaminophen 1000 mg PO Q8H:PRN pain 
2. Docusate Sodium 100 mg PO BID 
3. Polyethylene Glycol 17


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---

--- DEBUG: SINGLE AGENT SAMPLE (10/10) ---
Stay ID: 30348719
--- PROMPT TEXT ---
You are an expert ICU risk prediction model. Analyze the following data collected during the intensive care unit stay of this patient to determine whether the patient died during their stay. Note that some data modalities may be missing, so only process the ones that are provided. Respond *only* with 'Yes' if the patient died or 'No' if they did not. Do not add any other text.

--- DATA ---
Patient Summary and History:
PATIENT BASELINE SUMMARY:
------------------------
Demographics:
 - Age: 84
 - Gender: F
 - Ethnicity: UNKNOWN

History of Present Illness:
___ is an ___ year-old woman with a history of breast
cancer, HTN, GI bleed and PMR who presented to ___ yesterday
(___) w/ nausea, vomiting, diarrhea and abdominal pain 
and was found to have RLL PNA, pleural effusions, elevated
troponins (0.06). She was found to be in Afib with RVR and a TTE
showed new biventricular failure with LVEF 20%. Her WBC was 16k
on admission and increased to 28k today. A CTA on admission that
was read as concerning for colitis and noted new PEs and
pneumonia. Today, her abdomen became progressively distended and
frankly peritonitic. A repeat CT A/P which was concerning for
bowel ischemia. Transfer to a tertiary care center was initiated
and she was directly admitted to the SICU. She required
intubation for worsening hypoxia prior to transfer.

Past Medical History:
Breast Ca in ___ s/

Past Surgical History:
Achilles tendon repair (3 weeks ago)
bilateral mastectomy with ?TRAM flap c/

Social History:
___

Family History:


Medications on Admission:
-metoprolol ER 50' 
-simvastatin 10' 
-hydroxychloroquine 200' 
-Zofran prn 
-hydrocodone/acetaminophen ___ q4h prn
-escitalopram 10' 
-wixela inhub diskus 250/50 1puff BID
-flovent HFA 110 mcg 2


--- DECISION ---
-------------------
--- IMAGE ---
[No image attached for this sample]
---------------
--- END DEBUG SAMPLE ---
...Simulation complete.

Evaluating predictions...
...Evaluation complete.

==================================================
      Pipeline Finished Successfully
==================================================

Agent Setup: SingleAgent

--- Evaluation Summary ---
{
    "in_hospital_mortality_metrics": {
        "Survived": {
            "precision": 0.893368700265252,
            "recall": 0.944475602916433,
            "f1-score": 0.9182115594329335,
            "support": 1783.0
        },
        "Mortality": {
            "precision": 0.23255813953488372,
            "recall": 0.12987012987012986,
            "f1-score": 0.16666666666666666,
            "support": 231.0
        },
        "accuracy": 0.8510427010923535,
        "macro avg": {
            "precision": 0.5629634199000678,
            "recall": 0.5371728663932814,
            "f1-score": 0.5424391130498001,
            "support": 2014.0
        },
        "weighted avg": {
            "precision": 0.8175756319788989,
            "recall": 0.8510427010923535,
            "f1-score": 0.8320115245625226,
            "support": 2014.0
        },
        "auroc": 0.5971695158459038,
        "auprc": 0.16256200777382085
    },
    "modality_usage_analysis": {
        "total_modality_requests": 6042,
        "average_modalities_per_patient": 3.0,
        "request_counts": {
            "patient_summary": 2014,
            "ehr_timeseries": 2014,
            "cxr": 0,
            "radiology_report": 2014
        },
        "percentage_of_patients_requesting_modality": {
            "patient_summary": 1.0,
            "ehr_timeseries": 1.0,
            "cxr": 0.0,
            "radiology_report": 1.0
        },
        "percentage_request_when_available": {
            "cxr": 0.0,
            "radiology_report": 1.1023535851122057
        }
    },
    "total_patients_evaluated": 2014
}

Detailed results saved to: ./results/varyingmods/SingleAgent_detailed_results.json
Evaluation summary saved to: ./results/varyingmods/SingleAgent_evaluation_summary.json
